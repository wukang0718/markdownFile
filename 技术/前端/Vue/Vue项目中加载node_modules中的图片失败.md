# Vue项目中加载node_modules中的图片失败

## 原因

1. 当`vue`以`lib`方式打包的库，默认的`publicPath`是空字符串

![img](/Users/aibee/gitspace/知识库/技术/前端/Vue/Vue项目中加载node_modules中的图片失败.assets/1690959664645-70630521-f4fc-4489-8423-8eb3189f5921.png)

执行时的 `publicPath`是通过`document.currentScript`获取的

因为执行时是通过动态生成`script`标签加载的`js`文件，所以`document.currentScript`获取的是`null`，所以实际执行时的 `publicPath`还是这个空字符串

所以实际执行时的 `publicPath`就应该是 `webpack.publicPath`

1. 在`vue`项目打包的时候不会处理 `node_module`下的资源

## 解决方案

### 图片转base64

使用 `url-loader`可以实现把图片转成 `base64`

```javascript
module.exports = {
  publicPath: './',
  chainWebpack: config => {
    config.module.rule('images')
      .use('url-loader')
      .loader('url-loader')
      .tap(options => {
        options.limit = 10 * 1024
        return options
      })
  }
}
```

优点：

不再需要通过网络请求加载，可以完全的解决掉图片加载路径不对的问题

缺点：

当图片文件太大时，会导致打包后的js文件大，加载js文件耗时

### 把图片复制到输出目录

使用`copy-webpack-plugin` 可以实现把图片复制到输出目录

```javascript
const CopyWebpackPlugin = require('copy-webpack-plugin')
module.exports = {
  configureWebpack: (config) => {
    config.plugins.push(new CopyWebpackPlugin([
      { from: resolve('node_modules/xxx/dist/img'), to: resolve('dist/img') },
    ]))
  }
}
```

优点：

直接复制图片

缺点：

当使用库的项目中配置的 `publicPath`和 库打包时候的 `publicPath`不一致的时候，仍然会出现图片加载失败的问题

#### 在库打包的时候指定一个PublicPath

```javascript
const WebpackPublicPathPlugin = require('vuecli-publicpath-webpack-plugin')

module.exports = {
  ...
  configureWebpack:(config)=>{
    config.plugins = [
      ...config.plugins,
      new WebpackPublicPathPlugin('your cdn path')
    ]
  }
}
```