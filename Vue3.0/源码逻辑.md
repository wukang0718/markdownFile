## ref 方法

> 源码地址：[https://github.com/vuejs/vue-next/blob/master/packages/reactivity/src/ref.ts](https://github.com/vuejs/vue-next/blob/master/packages/reactivity/src/ref.ts)

```typescript
export function ref(value?: unknown) {
  return createRef(value)
}
```

调用 `createRef` 方法

#### createRef 方法

判断如果已经是 `ref` 对象，直接返回这个对象

否则，返回一个 `RefImpl` 类型的实例

```typescript
function createRef(rawValue: unknown, shallow = false) {
  if (isRef(rawValue)) { // 判断是否已经是 ref 对象
    return rawValue
  }
  return new RefImpl(rawValue, shallow)
}
```

#### RefImpl 类

`new` 接收两个参数

| 参数      | 描述                                            |
| --------- | ----------------------------------------------- |
| _rawValue | 原始值                                          |
| _shallow  | 是否只做浅层的代理，默认值 false 做 深层 的代理 |

实例属性：

| 属性      | 描述                                                    |
| --------- | ------------------------------------------------------- |
| _value    | 原始值                                                  |
| __v_isRef | ref 对象的表示，在判断对象是不是 ref 对象的时候，会用到 |
| _rawValue | 原始值 或 修改后的原始值                                |
| _shallow  | 是否只做浅层的监听                                      |
| value     | 暴露给外层访问的属性，会调用 get、set 方法              |

```typescript
class RefImpl<T> {
  private _value: T

  public readonly __v_isRef = true

  constructor(private _rawValue: T, public readonly _shallow = false) {
    this._value = _shallow ? _rawValue : convert(_rawValue) // convert 函数做深层的代理
  }

  get value() {
    track(toRaw(this), TrackOpTypes.GET, 'value') // track 函数收集依赖，后续描述
    return this._value
  }

  set value(newVal) {
    if (hasChanged(toRaw(newVal), this._rawValue)) { // 如果修改后的值，和当前值不一致
      this._rawValue = newVal
      this._value = this._shallow ? newVal : convert(newVal)
      trigger(toRaw(this), TriggerOpTypes.SET, 'value', newVal) // trigger 函数触发依赖，后续描述
    }
  }
}
```

#### convert 函数

接收一个参数，如果参数是对象类型，调用 reactive 方法，否则返回参数本身

```typescript
const convert = <T extends unknown>(val: T): T =>
  isObject(val) ? reactive(val) : val
```

## toRaw 方法

> 源码位置： [https://github.com/vuejs/vue-next/blob/master/packages/reactivity/src/reactive.ts](https://github.com/vuejs/vue-next/blob/master/packages/reactivity/src/reactive.ts)

这个方法会返回 `reactive` 对象的原始值，如果不是 `reactive` 对象，就放回接收的参数

```typescript
export function toRaw<T>(observed: T): T {
  return (
    (observed && toRaw((observed as Target)[ReactiveFlags.RAW])) || observed
  )
}
```





















